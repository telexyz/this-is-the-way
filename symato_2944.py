SYMATO_MARKTONES = "| |s |f |r |x |j |w |ws |wf |wr |wx |wj |z |zs |zf |zr |zx |zj"
SYMATO_SYMS = "a ac ach ai am an ang anh ao ap at au ay ba bac bach bai bam ban bang banh bao bap bat bau bay be bec bech bem ben beng benh beo bep bet beu bi bia bic bich biec biem bien bieng bienh biep biet bieu bim bin bing binh bip bit biu bo boa boac boan boang boao boc boch boe boem boeng boi bom bon bong boo booc boom boon boong bop bot bu bua buan buang buc buch bue buet bui bum bun bung bunh buo buoc buoi buom buon buong buop buot buou buoy bup but buu buy buyng buyp buyt by ca cac cach cai cam can cang canh cao cap cat cau cay ce cec cem cen ceng cenh ceo cha chac chach chai cham chan chang chanh chao chap chat chau chay che chec chech chem chen cheng chenh cheo chep chet cheu chi chia chic chich chiec chiem chien chieng chiep chiet chieu chim chin ching chinh chip chit chiu cho choa choac choach choai choam choan choang choanh choap choat choay choc choe choem choen choeng choet choi chom chon chong chonh choo chooc choom choon choong chop chot chu chua chuam chuan chuat chuc chue chuec chuech chuen chuenh chui chum chun chung chunh chuo chuoc chuoi chuom chuon chuong chuop chuot chup chut chuu chuy chuya chuyec chuyech chuyem chuyen chuyenh chuyep chuyet chuyn chy ci cia ciec cien cieu cim cin cing cinh cit ciu co coa coai coam coan coang coc coe coem coen coi com con cong conh coo cooc coom coon coong cop cot cu cua cuan cuang cuat cuc cui cum cun cung cunh cuo cuoc cuoi cuom cuon cuong cuop cuot cuou cup cut cuu cuy cuyen cy da dac dach dai dam dan dang danh dao dap dat dau day dda ddaa ddac ddach ddai ddam ddan ddang ddanh ddao ddap ddat ddau dday dde ddec ddech ddem dden ddeng ddenh ddeo ddep ddet ddeu ddi ddia ddic ddich ddiec ddiem ddien ddieng ddiep ddiet ddieu ddim ddin dding ddinh ddip ddit ddiu ddo ddoa ddoac ddoach ddoai ddoam ddoan ddoang ddoanh ddoat ddoc ddoch ddoe ddoen ddoi ddom ddon ddong ddonh ddoo ddooc ddoong ddop ddot ddu ddua dduc ddue dduenh ddui ddum ddun ddung ddunh dduo dduoc dduoi dduom dduon dduong dduot dduou ddup ddut dduu dduy dduya dduych dduyen dduyet dduyn dduynh ddy de dec dech dem den deng denh deo dep det deu di dia dic dich diec diem dien dieng diep diet dieu dim din ding dinh dip dit diu do doa doai doan doang doanh doat doc doch doe doem doen doi dom don dong donh doo dooc doom doon doong dop dot du dua duan duang duat duc duch due duenh dui dum dun dung dunh duo duoc duoi duom duon duong duonh duop duot dup dut duu duy duyen duyenh duyet duynh duyp duyt dy e ec ech em en eng enh eo ep et eu ga gac gach gai gam gan gang ganh gao gap gat gau gay ge gec gech gem gen geng genh geo gep get gha ghac ghach ghai gham ghan ghang ghanh ghap ghat ghay ghe ghec ghech ghem ghen ghenh gheo ghep ghet ghi ghia ghich ghiec ghiem ghien ghieng ghiep ghiet ghim ghin ghinh ghip ghit ghiu gho ghom ghong ghop ghot ghu ghuan ghun ghup gi gia giac giai giam gian giang gianh giao giap giat giau giay gic gich gie giec giem gien gieng gienh gieo giep giet gieu gim gin ging ginh gio gioa gioan gioang gioc gioi giom gion giong gionh giooc gioong giop giot gip git giu giua giuc giui gium giun giung giuo giuoc giuoi giuon giuong giup giut giuu giuy giuyp go goa goac goai goam goan goang goap goay goc goe goen goi gom gon gong gonh goo gooc goon goong gop got gu gua guan guay guc guet gui gum gun gung guo guoc guoi guom guon guong guot gup gut guu guy guyen guyet guym guyn gy ha hac hach hai ham han hang hanh hao hap hat hau hay he hec hech hem hen heng henh heo hep het heu hi hia hic hich hiec hiem hien hieng hienh hiep hiet hieu him hin hing hinh hip hit hiu ho hoa hoac hoach hoai hoam hoan hoang hoanh hoao hoap hoat hoay hoc hoch hoe hoen hoet hoi hom hon hong hoo hooc hoon hoong hop hot hu hua huan huat huay huc hue huech huen huenh huet hui hum hun hung hunh huo huoc huoi huom huon huong huonh huot huou hup hut huu huy huya huych huyech huyen huyenh huyep huyet huyn huyng huynh huyt hy i ia ich im in ing inh ip it iu ka kac kach kai kam kan kang kanh kao kap kat kau kay ke kec kech kem ken keng kenh keo kep ket keu kha khac khach khai kham khan khang khanh khao khap khat khau khay khe khec khech khem khen kheng khenh kheo khep khet kheu khi khia khic khich khiec khiem khien khieng khiep khiet khieu khim khin khing khinh khip khit khiu kho khoa khoac khoach khoai khoam khoan khoang khoanh khoat khoay khoc khoe khoec khoen khoeng khoeo khoet khoi khom khon khong khonh khoo khooc khoon khoong khoop khop khot khu khua khuan khuang khuat khuay khuc khue khuech khuen khuenh khuet khui khum khun khung khunh khuo khuoc khuoi khuom khuon khuong khuot khuou khup khut khuu khuy khuya khuyec khuyech khuyem khuyen khuyenh khuyet khuyng khuynh khuyu khy ki kia kic kich kiec kiem kien kieng kienh kiep kiet kieu kim kin king kinh kip kit kiu ko koa koach koai koam koang koanh koay koc koe koem koen koi kom kon kong koo kooc koom koon koong koonh kop kot ku kua kuan kuat kuc kue kueng kui kum kun kung kuo kuoi kuon kuong kuop kut kuy kuyen kuyng ky la lac lach lai lam lan lang lanh lao lap lat lau lay le lec lech lem len leng lenh leo lep let leu li lia lic lich liec liem lien lieng liep liet lieu lim lin ling linh lip lit liu lo loa loac loach loai loam loan loang loanh loat loay loc loch loe loem loen loeng loeo loet loi lom lon long lonh loo looc loom loon loong lop lot lu lua luan luang luap luat luay luc lue luen luenh luet lui lum lun lung lunh luo luoc luoi luom luon luong luonh luop luot lup lut luu luy luya luych luyen luyet luyn luynh luyt ly ma mac mach mai mam man mang manh mao map mat mau may me mec mech mem men meng menh meo mep met meu mi mia mic mich miec miem mien mieng mienh miep miet mieu mim min ming minh mip mit miu mo moa moac moai moan moang moay moc moe moen moi mom mon mong monh moo mooc moom moon moong mop mot mu mua muan muay muc much mui mum mun mung munh muo muoc muoi muom muon muong muonh muop muot muou mup mut muu muy muya muyng my na nac nach nai nam nan nang nanh nao nap nat nau nay ne nec nech nem nen neng nenh neo nep net neu nga ngac ngach ngai ngam ngan ngang nganh ngao ngap ngat ngau ngay nge ngech ngen ngenh ngeo nget ngeu ngha nghac nghach nghai ngham nghan nghang nghanh nghao nghap nghat nghau nghe nghec nghech nghem nghen ngheng nghenh ngheo nghep nghet ngheu nghi nghia nghic nghich nghiec nghiem nghien nghieng nghienh nghiep nghiet nghieu nghim nghin nghing nghinh nghip nghit nghiu ngho nghoanh nghoc nghoe nghoeo nghoi nghom nghong nghot nghu nghuech nghuen nghung nghuoi nghuong nghut nghuy nghuyen nghuyet ngi ngia ngich ngiem ngien ngieng ngiep ngiet ngieu ngim ngin nginh ngit ngiu ngo ngoa ngoac ngoach ngoai ngoam ngoan ngoang ngoanh ngoao ngoap ngoat ngoay ngoc ngoe ngoem ngoen ngoeo ngoet ngoi ngom ngon ngong ngoong ngoot ngop ngot ngu ngua nguan nguay nguc nguech nguen nguenh ngui ngum ngun ngung nguo nguoc nguoi nguom nguon nguong nguot nguou ngup ngut nguu nguy nguych nguyech nguyem nguyen nguyeng nguyet nguyn nguyt ngy nha nhac nhach nhai nham nhan nhang nhanh nhao nhap nhat nhau nhay nhe nhec nhech nhem nhen nheng nhenh nheo nhep nhet nheu nhi nhia nhic nhich nhiec nhiem nhien nhieng nhiep nhiet nhieu nhim nhin nhinh nhip nhit nhiu nho nhoa nhoach nhoai nhoam nhoan nhoang nhoanh nhoat nhoay nhoc nhoe nhoem nhoen nhoep nhoet nhoi nhom nhon nhong nhooc nhoong nhop nhot nhu nhua nhuan nhuat nhuc nhue nhuech nhuen nhui nhum nhun nhung nhunh nhuo nhuoc nhuoi nhuom nhuon nhuong nhuot nhup nhut nhuu nhuy nhuyen nhuyet nhuyn nhy ni nia nic nich niec niem nien nieng niep niet nieu nim nin ning ninh nip nit niu no noa noac noai noam noan noanh noao noat noc noe noem noen noeng noi nom non nong nonh noo nooc noom noon noong noonh nop not nu nua nuan nuc nue nuech nui num nun nung nuo nuoc nuoch nuoi nuom nuon nuong nuop nuot nuou nup nut nuu nuy nuyen nuyp nuyu ny o oa oac oach oai oam oan oang oanh oao oap oat oc och oe oem oen oeo oep oet oi om on ong onh oo ooc oom oon oong op ot pa pac pach pai pam pan pang panh pao pap pat pau pay pe pec pech pem pen peng penh peo pep pet pha phac phach phai pham phan phang phanh phao phap phat phau phay phe phec phech phem phen pheng phenh pheo phep phet pheu phi phia phic phich phiec phiem phien phieng phiep phiet phieu phim phin phing phinh phip phit phiu pho phoa phoai phoang phoanh phoc phoi phom phon phong phonh phoo phooc phoong phop phot phu phua phuan phuat phuc phui phum phun phung phuo phuoc phuoi phuon phuong phuot phup phut phuu phuy phuya phuyen phuyet phuynh phy pi pia pic pich piec piem pien pieng piet pieu pim pin ping pinh pip pit piu po poa poang poat poc poe poem poi pom pon pong ponh poo pooc poom poon poong pop pot pu pua puan puat puc puch pui pum pun pung punh puo puoc puoi puon puong pup put puy puya puyu py qua quac quach quai quam quan quang quanh quao quap quat quau quay que quech quen queng quenh queo quet queu qui quia quiet quin quing quit quiu quo quoac quoai quoam quoan quoang quoanh quoat quoay quoc quoet quoi quon quong quop quot quu quuay quuy quuyen quuyet quy quych quyen quyeng quyenh quyet quyn quyng quynh quyt ra rac rach rai ram ran rang ranh rao rap rat rau ray re rec rech rem ren reng renh reo rep ret reu ri ria ric rich riec riem rien rieng riep riet rieu rim rin ring rinh rip rit riu ro roa roac roach roai roam roan roang roanh roap roat roay roc roe roem roen roeng roet roi rom ron rong roo rooc room roon roong rop rot ru rua ruan ruc ruch rue rui rum run rung runh ruo ruoc ruoi ruom ruon ruong ruop ruot ruou rup rut ruu ruy ruyen ruyet ry sa sac sach sai sam san sang sanh sao sap sat sau say se sec sech sem sen seng senh seo sep set seu si sia sic sich siec siem sien sieng siep siet sieu sim sin sing sinh sip sit siu so soa soac soai soam soan soang soanh soap soat soay soc soe soem soet soi som son song sonh soo sooc soon soong sop sot su sua suan suat suay suc sue suec suech sui sum sun sung suo suoc suoi suom suon suong suot suou sup sut suu suy suya suyen suyet suyn suyt suyu sy ta tac tach tai tam tan tang tanh tao tap tat tau tay te tec tech tem ten teng tenh teo tep tet teu tha thac thach thai tham than thang thanh thao thap that thau thay the thec thech them then theng thenh theo thep thet theu thi thia thic thich thiec thiem thien thieng thiep thiet thieu thim thin thing thinh thip thit thiu tho thoa thoac thoach thoai thoan thoang thoanh thoat thoay thoc thoe thoen thoi thom thon thong thonh thoo thooc thoon thoong thop thot thu thua thuam thuan thuang thuat thuay thuc thue thuen thuenh thuet thui thum thun thung thuo thuoc thuoi thuom thuon thuong thuonh thuot thup thut thuu thuy thuya thuyen thuyet thuyn thuynh thy ti tia tic tich tiec tiem tien tieng tiep tiet tieu tim tin ting tinh tip tit tiu to toa toac toach toai toan toang toanh toat toay toc toe toen toet toi tom ton tong tonh too tooc toon toong top tot tra trac trach trai tram tran trang tranh trao trap trat trau tray tre trec trech trem tren treng trenh treo trep tret treu tri tria tric trich triec triem trien trieng triep triet trieu trim trin tring trinh trip trit triu tro troa troac troat troc troe troet troi trom tron trong tronh trooc troon troong trop trot tru trua truan truat truc true truen truenh trui trum trun trung trunh truo truoc truoi truom truon truong truonh truot trut truu truy truyen truyenh truyet truyp try tu tua tuan tuat tuc tue tuech tuen tuenh tuet tui tum tun tung tunh tuo tuoc tuoi tuom tuon tuong tuop tuot tuou tup tut tuu tuy tuya tuyech tuyem tuyen tuyenh tuyep tuyet tuyn tuynh tuyp tuyt tuyu ty u ua uan uang uap uat uay uc ue uech uen uet ui um un ung unh uo uoc uoi uom uon uong uonh uop uot uou uoy up ut uu uy uych uyen uyet uym uyn uynh uyt va vac vach vai vam van vang vanh vao vap vat vau vay ve vec vech vem ven veng venh veo vep vet veu vi via vic vich viec viem vien vieng viep viet vieu vim vin ving vinh vip vit viu vo voa voai voan voang voc voch voe voi vom von vong voo vooc voom voon voong vop vot vu vua vuc vuec vui vum vun vung vunh vuo vuoc vuoi vuom vuon vuong vuop vuot vut vuu vuy vy xa xac xach xai xam xan xang xanh xao xap xat xau xay xe xec xech xem xen xeng xenh xeo xep xet xeu xi xia xic xich xiec xiem xien xieng xiep xiet xieu xim xin xing xinh xip xit xiu xo xoa xoac xoach xoai xoam xoan xoang xoanh xoap xoat xoay xoc xoe xoen xoeng xoet xoi xom xon xong xoo xooc xoom xoon xoong xop xot xu xua xuam xuan xuat xuay xuc xuch xue xuech xuen xuenh xui xum xun xung xunh xuoc xuoi xuom xuon xuong xuop xuot xup xut xuy xuyec xuyen xuyenh xuyet xuynh xuyt xy y yec yem yen yeng yet yeu toam noang tuych ruych guang guat trup thuou troam troai uenh uenh uenh uenh giuom uenh uenh goem quinh soach hoem quoong xuya ghy dduop toap nhuay xuet quem khuam uenh troang dduem chuang nuyet nguyu quinh uenh xuya uya duen quich quich vuan nuyet uam uenh nguynh giuom quich uenh buynh xuet quem khuam uenh troang dduem chuang nuyet nguyu quinh uenh xuya uya duen quich quich vuan nuyet uam uenh nguynh giuom quich uenh buynh uenh uenh uenh uenh giuom uenh uenh goem quinh soach hoem quoong xuya ghy dduop toap nhuay quich quich quich xuya uya duen chuang troang quem uenh xuya soach quinh quoong ghy goem uenh uenh uenh uenh toap hoem dduop nhuay giuom buynh uam uenh nuyet uenh xuet giuom uenh uenh vuan nguyu khuam nguynh"
'''
2944 vocab, `u16` type:
- `000 ... 255`:  255 bytes
- `256 ... 273`:   18 marktones
- `274`        : '^' viết hoa chữ cái đầu của sym
- `275`        : '^^' viết hoa toàn bộ sym
- `276 ...    `: 2666 syms
'''

marktones = SYMATO_MARKTONES.split()
assert len(marktones) == 18

syms = SYMATO_SYMS.split()
assert len(syms) == 2666

from bogo.core import process_sequence as telex_to_utf8
class Symato:
	# def syllable_to_tids(self, syllable): return UTF8_TO_TIDS[syllable.lower()]
	def is_sym_capitalized(self, token_id): return token_id == 275 # viết hoa toàn bộ âm tiết
	def is_capitalized(self, token_id): return token_id == 275 or token_id == 274 # viết hoa chữ đầu hoặc toàn bộ
	def is_byte(self, token_id): return token_id <= 255
	def is_marktone(self, token_id): return 256 <= token_id and token_id <= 273
	def is_sym(self, token_id): return 276 <= token_id and token_id <= 2944 # âm tiết không dấu thanh
	def vocab_size(self): return 2944

	# Biến đổi sym_id + marktone_id thành utf-8 string: VD: 274 + 258 => "à"
	def to_utf8(self, sym_id, marktone_id):
		return telex_to_utf8(self.itos[sym_id] + self.itos[marktone_id][1:])

	# Biến đổi chuỗi token_ids thành utf-8 string: VD: [274, 256, 274, 274, 258] => "a À"
	def tids_to_utf8(self, tids):
		i, n = -1, len(tids) - 1
		str = ""; cap_id = None
		prev_tid = 0
		while i < n:
			i += 1
			tid = tids[i]

			if self.is_capitalized(tid):
				cap_id = tid
			else:
				token = None
				if self.is_sym(tid):
					mtid = tids[i + 1] if i < n else 0
					if self.is_marktone(mtid):
						token = self.to_utf8(tid, mtid)
						i += 1
					if self.is_sym(prev_tid): str += " " # thêm space giữa 2 syllables
				if token is None: token = self.decode(tid)

				if cap_id != None:
					if self.is_sym_capitalized(cap_id): token = token.upper()
					else: token = token[0].upper() + token[1:]
					cap_id = None
				
				str += token
				prev_tid = tid

		return str

	# Khởi tạo
	def __init__(self):
		self.stoi = {"^": 274, "^^": 275}
		self.itos = {274: "^", 275: "^^"}

		for i, s in enumerate(marktones):
			sid = i + 256
			self.stoi[s] = sid
			self.itos[sid] = s
		assert self.stoi["|zj"] == 273
		assert self.itos[256] == "|"

		for i, s in enumerate(syms):
			sid = i + 276
			self.stoi[s] = sid
			self.itos[sid] = s
		assert self.stoi["yeu"] == 2809
		assert self.itos[276] == "a"

	# Biến token id (tid) thành token
	def decode(self, tid):
		if isinstance(tid, int):
			return self.itos[tid] if tid > 255 else chr(tid)
		else:
			return " ".join([ self.itos[i] if i > 255 else chr(i) for i in tid ])

	# Biến text đầu vào thành token ids (tids)
	def encode(self, a, maxx=None, rev=False):
		tids = self.encode_(a, maxx, rev)
		mtid = len(tids) - 1
		compact_tids = []
		# Loại bỏ space giữa marktone và sym để tiết kiệm ctx_len
		for i, tid in enumerate(tids):
			if tid == 32: # space
				if i > 0 and self.is_marktone(tids[i - 1]): # previous tid is marktone
					if i < mtid:
						x = tids[i + 1]
						if self.is_capitalized(x) or self.is_sym(x): # next tid is a sym or a cap
							continue
			compact_tids.append(tid)
		return compact_tids

	def encode_(self, a, maxx=None, rev=False):
		if isinstance(a, str): a = bytes(a, "utf8")
		b, e = 0, len(a)
		if maxx is None: maxx = e
		if maxx > e: maxx = e
		tids = []
		while (b < maxx):
			c = a[b]
			if c == 16:
				n = b + 1
				while a[n] != 16: n += 1
				s = str(a[b+1:n], "utf8")
				if s[0] == '^':
					if s[1] == '^':
						tids.append(self.stoi["^^"])
						s = s[2:]
					else:
						tids.append(self.stoi["^"])
						s = s[1:]

				idx = s.find("|")
				if idx > -1:
					try: sym_id = self.stoi[s[0:idx]]
					except: print(s[0:idx], end=" ", flush=True)
					marktone_id = self.stoi[s[idx:]]
				else:
					sym_id = self.stoi[s]
					marktone_id = None
				if rev:
					if len(tids) > 0 and self.is_capitalized(tids[-1]):
						tmp = tids[-1]
						tids[-1] = marktone_id
						tids.append(sym_id)
						tids.append(tmp)
					else:
						tids.append(marktone_id)
						tids.append(sym_id)
				else:
					tids.append(sym_id)
					if marktone_id is not None: tids.append(marktone_id)
				b = n + 1
			else:
				tids.append(c)
				b += 1
		a = None
		if rev: tids.reverse()
		return tids

	def tokenize(self, filename, maxx=None, rev=False):
		return self.encode(open(filename,"rb").read(), maxx, rev)


symato = Symato()
text = "a| ^a|f  ^^a|s"
tids = symato.encode(text)
assert tids == [276, 256, 274, 276, 258, 32, 32, 275, 276, 257]
# print(tids, symato.tids_to_utf8(tids))
assert symato.tids_to_utf8(tids) == "a À  Á"
tids = symato.encode(text, rev=True)
assert tids == [275, 276, 257, 32, 32, 274, 276, 258, 276, 256]
assert symato.tids_to_utf8(tids) == "Á  À a"

# UTF8_TO_TIDS = {}
# for sym in syms:
# 	UTF8_TO_TIDS[sym] = (symato.stoi[sym], 256)
# 	# if sym[0:2] != "ao":
# 	for marktone in marktones:
# 		s = sym + marktone[1:]
# 		u = telex_to_utf8(s)
# 		if len(s) > len(u):
# 			UTF8_TO_TIDS[u] = [symato.stoi[sym], symato.stoi[marktone]]
# print(UTF8_TO_TIDS)
# print(len(UTF8_TO_TIDS))